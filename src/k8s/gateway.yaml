# GatewayClass
apiVersion: gateway.networking.k8s.io/v1beta1
kind: GatewayClass
metadata:
  name: kong
  annotations:
    konghq.com/gatewayclass-unmanaged: 'true'
spec:
  controllerName: konghq.com/kic-gateway-controller

---
# Gateway
apiVersion: gateway.networking.k8s.io/v1beta1
kind: Gateway
metadata:
  name: count-collection-gateway
  namespace: count-collection-system
spec:
  gatewayClassName: kong
  listeners:
    - name: proxy
      protocol: HTTP
      port: 80
      allowedRoutes:
        namespaces:
          from: All

---
# HTTPRoute for CountCollectAPI
apiVersion: gateway.networking.k8s.io/v1beta1
kind: HTTPRoute
metadata:
  name: count-api-collect-route
  namespace: count-collection-system
spec:
  parentRefs:
    - name: count-collection-gateway
      namespace: count-collection-system
  rules:
    - matches:
        - path:
            type: Exact
            value: /api/v1/collect
          method: POST
      backendRefs:
        - name: count-api-service
          port: 80

---
# HTTPRoute for CountQueryAPI
apiVersion: gateway.networking.k8s.io/v1beta1
kind: HTTPRoute
metadata:
  name: count-api-query-route
  namespace: count-collection-system
spec:
  parentRefs:
    - name: count-collection-gateway
      namespace: count-collection-system
  rules:
    - matches:
        - path:
            type: Exact
            value: /api/v1/counts
          method: GET
      backendRefs:
        - name: count-api-service
          port: 80

---
# HTTPRoute for CountUIAPI
apiVersion: gateway.networking.k8s.io/v1beta1
kind: HTTPRoute
metadata:
  name: count-api-ui-route
  namespace: count-collection-system
spec:
  parentRefs:
    - name: count-collection-gateway
      namespace: count-collection-system
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /ui/counts
      backendRefs:
        - name: count-api-service
          port: 80

---
# HTTPRoute for Health Check
apiVersion: gateway.networking.k8s.io/v1beta1
kind: HTTPRoute
metadata:
  name: count-api-health-route
  namespace: count-collection-system
spec:
  parentRefs:
    - name: count-collection-gateway
      namespace: count-collection-system
  rules:
    - matches:
        - path:
            type: Exact
            value: /health
          method: GET
      backendRefs:
        - name: count-api-service
          port: 80
